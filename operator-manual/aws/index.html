
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Compliant Kubernetes is a Kubernetes distribution that reduces the burden for complying with HIPAA, Swedish Healthcare (Patientdatalagen), GDPR and ISO 27001.">
      
      
      
        <meta name="author" content="Elastisys AB">
      
      
        <link rel="canonical" href="https://compliantkubernetes.io/operator-manual/aws/">
      
      <link rel="icon" href="../../img/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.0">
    
    
      
        <title>On AWS - Compliant Kubernetes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.33e2939f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-68368435-4","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#compliant-kubernetes-deployment-on-aws" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Compliant Kubernetes" class="md-header__button md-logo" aria-label="Compliant Kubernetes" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Compliant Kubernetes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              On AWS
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        
<a href="https://github.com/elastisys/compliantkubernetes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Compliant Kubernetes" class="md-nav__button md-logo" aria-label="Compliant Kubernetes" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    Compliant Kubernetes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/elastisys/compliantkubernetes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../compliance/" class="md-nav__link">
        Compliance Basics
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/" class="md-nav__link">
        Core Concepts
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../benefits/" class="md-nav__link">
        Exploring Benefits
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      <label class="md-nav__link" for="__nav_6">
        User Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="User Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          User Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/harbor/" class="md-nav__link">
        Harbor
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/kubernetes-api/" class="md-nav__link">
        Kubernetes API
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/elasticsearch/" class="md-nav__link">
        Elasticsearch/Kibana
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/prometheus/" class="md-nav__link">
        Prometheus/Grafana
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/dashboard/" class="md-nav__link">
        Dashboard
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/backup/" class="md-nav__link">
        Backups
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      <label class="md-nav__link" for="__nav_7">
        CISO Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="CISO Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          CISO Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/backup/" class="md-nav__link">
        Backup
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/cryptography/" class="md-nav__link">
        Cryptography
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/intrusion-detection/" class="md-nav__link">
        Intrusion Detection
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/policy-as-code/" class="md-nav__link">
        Policy-as-Code
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/network-security/" class="md-nav__link">
        Network Security
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../ciso-guide/kubernetes-status/" class="md-nav__link">
        Kubernetes Status
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" checked>
      
      <label class="md-nav__link" for="__nav_8">
        Operator Manual
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Operator Manual" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Operator Manual
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_3" type="checkbox" id="__nav_8_3" checked>
      
      <label class="md-nav__link" for="__nav_8_3">
        Creating/Destroying/Upgrading a Cluster
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Creating/Destroying/Upgrading a Cluster" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_3">
          <span class="md-nav__icon md-icon"></span>
          Creating/Destroying/Upgrading a Cluster
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          On AWS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        On AWS
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-vanilla-kubernetes-clusters" class="md-nav__link">
    Deploying vanilla Kubernetes clusters
  </a>
  
    <nav class="md-nav" aria-label="Deploying vanilla Kubernetes clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-setup-using-terraform" class="md-nav__link">
    Infrastructure Setup using Terraform
  </a>
  
    <nav class="md-nav" aria-label="Infrastructure Setup using Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expose-aws-credentials-to-terraform" class="md-nav__link">
    Expose AWS credentials to Terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customize-your-infrastructure" class="md-nav__link">
    Customize your infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialize-and-apply-terraform" class="md-nav__link">
    Initialize and Apply Terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-that-the-ansible-inventory-was-properly-generated" class="md-nav__link">
    Check that the Ansible inventory was properly generated
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-vanilla-kubernetes-clusters-using-kubespray" class="md-nav__link">
    Deploying vanilla Kubernetes clusters using Kubespray
  </a>
  
    <nav class="md-nav" aria-label="Deploying vanilla Kubernetes clusters using Kubespray">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init-the-kubespray-config-in-your-config-path" class="md-nav__link">
    Init the Kubespray config in your config path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-the-inventories-generated-by-terraform-above-in-the-right-place" class="md-nav__link">
    Copy the inventories generated by Terraform above in the right place
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-kubespray-to-deploy-the-kubernetes-clusters" class="md-nav__link">
    Run kubespray to deploy the Kubernetes clusters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correct-the-kubernetes-api-ip-addresses" class="md-nav__link">
    Correct the Kubernetes API IP addresses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-access-to-the-clusters-as-follows" class="md-nav__link">
    Test access to the clusters as follows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-compliant-kubernetes-apps" class="md-nav__link">
    Deploying Compliant Kubernetes Apps
  </a>
  
    <nav class="md-nav" aria-label="Deploying Compliant Kubernetes Apps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clone-compliantkubernetes-apps-and-install-pre-requisites" class="md-nav__link">
    Clone compliantkubernetes-apps and Install Pre-requisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialize-the-apps-configuration" class="md-nav__link">
    Initialize the apps configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-apps" class="md-nav__link">
    Configure the apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-placeholder-dns-entries" class="md-nav__link">
    Create placeholder DNS entries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-compliant-kubernetes-apps" class="md-nav__link">
    Install Compliant Kubernetes apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#settling" class="md-nav__link">
    Settling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-required-dns-entries" class="md-nav__link">
    Setup required DNS entries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#teardown" class="md-nav__link">
    Teardown
  </a>
  
    <nav class="md-nav" aria-label="Teardown">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#removing-compliant-kubernetes-apps-from-your-cluster" class="md-nav__link">
    Removing Compliant Kubernetes Apps from your cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-infrastructure" class="md-nav__link">
    Remove infrastructure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    Further Reading
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../azure/" class="md-nav__link">
        On Azure
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../exoscale/" class="md-nav__link">
        On Exoscale
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gcp/" class="md-nav__link">
        On GCP
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../openstack/" class="md-nav__link">
        On Openstack
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ovh-managed-kubernetes/" class="md-nav__link">
        On OVH Managed Kubernetes
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../eksd/" class="md-nav__link">
        On EKS-D
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../clean-up/" class="md-nav__link">
        Remove Compliant Kubernetes Apps
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../qa/" class="md-nav__link">
        QA
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_5" type="checkbox" id="__nav_8_5" >
      
      <label class="md-nav__link" for="__nav_8_5">
        Configuring a Cluster
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Configuring a Cluster" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_5">
          <span class="md-nav__icon md-icon"></span>
          Configuring a Cluster
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ingress/" class="md-nav__link">
        Ingress
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../disaster-recovery/" class="md-nav__link">
        Disaster Recovery
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../break-glass/" class="md-nav__link">
        Breaking the Glass
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      <label class="md-nav__link" for="__nav_9">
        Developer Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Developer Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../developer-guide/tech-radar/" class="md-nav__link">
        Tech Radar
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../adr/" class="md-nav__link">
        Architectural Decision Log
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://compliantkubernetes.com/" class="md-nav__link">
        Support ⧉
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://elastisys.com/blog/" class="md-nav__link">
        Blog ⧉
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-vanilla-kubernetes-clusters" class="md-nav__link">
    Deploying vanilla Kubernetes clusters
  </a>
  
    <nav class="md-nav" aria-label="Deploying vanilla Kubernetes clusters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#infrastructure-setup-using-terraform" class="md-nav__link">
    Infrastructure Setup using Terraform
  </a>
  
    <nav class="md-nav" aria-label="Infrastructure Setup using Terraform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#expose-aws-credentials-to-terraform" class="md-nav__link">
    Expose AWS credentials to Terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customize-your-infrastructure" class="md-nav__link">
    Customize your infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialize-and-apply-terraform" class="md-nav__link">
    Initialize and Apply Terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-that-the-ansible-inventory-was-properly-generated" class="md-nav__link">
    Check that the Ansible inventory was properly generated
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-vanilla-kubernetes-clusters-using-kubespray" class="md-nav__link">
    Deploying vanilla Kubernetes clusters using Kubespray
  </a>
  
    <nav class="md-nav" aria-label="Deploying vanilla Kubernetes clusters using Kubespray">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init-the-kubespray-config-in-your-config-path" class="md-nav__link">
    Init the Kubespray config in your config path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-the-inventories-generated-by-terraform-above-in-the-right-place" class="md-nav__link">
    Copy the inventories generated by Terraform above in the right place
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-kubespray-to-deploy-the-kubernetes-clusters" class="md-nav__link">
    Run kubespray to deploy the Kubernetes clusters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correct-the-kubernetes-api-ip-addresses" class="md-nav__link">
    Correct the Kubernetes API IP addresses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-access-to-the-clusters-as-follows" class="md-nav__link">
    Test access to the clusters as follows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-compliant-kubernetes-apps" class="md-nav__link">
    Deploying Compliant Kubernetes Apps
  </a>
  
    <nav class="md-nav" aria-label="Deploying Compliant Kubernetes Apps">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clone-compliantkubernetes-apps-and-install-pre-requisites" class="md-nav__link">
    Clone compliantkubernetes-apps and Install Pre-requisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialize-the-apps-configuration" class="md-nav__link">
    Initialize the apps configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-apps" class="md-nav__link">
    Configure the apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-placeholder-dns-entries" class="md-nav__link">
    Create placeholder DNS entries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-compliant-kubernetes-apps" class="md-nav__link">
    Install Compliant Kubernetes apps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#settling" class="md-nav__link">
    Settling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-required-dns-entries" class="md-nav__link">
    Setup required DNS entries
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#teardown" class="md-nav__link">
    Teardown
  </a>
  
    <nav class="md-nav" aria-label="Teardown">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#removing-compliant-kubernetes-apps-from-your-cluster" class="md-nav__link">
    Removing Compliant Kubernetes Apps from your cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#remove-infrastructure" class="md-nav__link">
    Remove infrastructure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    Further Reading
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/elastisys/compliantkubernetes/edit/main/docs/operator-manual/aws.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="compliant-kubernetes-deployment-on-aws">Compliant Kubernetes Deployment on AWS</h1>
<p>This document describes how to set up Compliant Kubernetes on AWS.
The setup has two major parts:</p>
<ol>
<li>Deploying at least two vanilla Kubernetes clusters</li>
<li>Deploying Compliant Kubernetes apps</li>
</ol>
<p>Before starting, make sure you have <a href="../getting-started/">all necessary tools</a>.</p>
<h2 id="setup">Setup</h2>
<p>Choose names for your service cluster and workload clusters, as well as the DNS domain to expose the services inside the service cluster:</p>
<div class="highlight"><pre><span></span><code><span class="nv">SERVICE_CLUSTER</span><span class="o">=</span><span class="s2">&quot;testsc&quot;</span>
<span class="nv">WORKLOAD_CLUSTERS</span><span class="o">=(</span> <span class="s2">&quot;testwc0&quot;</span> <span class="o">)</span>
<span class="nv">BASE_DOMAIN</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to set up multiple workload clusters you can add more names.
E.g. <code>WORKLOAD_CLUSTERS=( "testwc0" "testwc1" "testwc2" )</code></p>
<p><code>SERVICE_CLUSTER</code> and each entry in <code>WORKLOAD_CLUSTERS</code> must be maximum 17 characters long.</p>
</div>
<h2 id="deploying-vanilla-kubernetes-clusters">Deploying vanilla Kubernetes clusters</h2>
<p>We suggest to set up Kubernetes clusters using kubespray.
If you haven't done so already, clone the Elastisys Compliant Kubernetes Kubespray repo as follows:</p>
<div class="highlight"><pre><span></span><code>git clone --recursive https://github.com/elastisys/compliantkubernetes-kubespray
<span class="nb">cd</span> compliantkubernetes-kubespray
</code></pre></div>
<h3 id="infrastructure-setup-using-terraform">Infrastructure Setup using Terraform</h3>
<h4 id="expose-aws-credentials-to-terraform">Expose AWS credentials to Terraform</h4>
<p>We suggest exposing AWS credentials to Terraform via environment variables, so they are not accidentally left on the file-system:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">TF_VAR_AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">&quot;xyz&quot;</span> <span class="c1"># Access key for AWS</span>
<span class="nb">export</span> <span class="nv">TF_VAR_AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">&quot;zyx&quot;</span> <span class="c1"># Secret key for AWS</span>
<span class="nb">export</span> <span class="nv">TF_VAR_AWS_SSH_KEY_NAME</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span> <span class="c1"># Name of the AWS key pair to use for the EC2 instances</span>
<span class="nb">export</span> <span class="nv">TF_VAR_AWS_DEFAULT_REGION</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span> <span class="c1"># Region to use for all AWS resources</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We suggest generating the SSH key locally, then importing it to AWS.</p>
</div>
<h4 id="customize-your-infrastructure">Customize your infrastructure</h4>
<p>Create a configuration for the service cluster and the workload cluster:</p>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span> kubespray
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    cat contrib/terraform/aws/terraform.tfvars <span class="se">\</span>
    <span class="p">|</span> sed <span class="se">\</span>
        -e <span class="s2">&quot;s@^aws_cluster_name =.*@aws_cluster_name = \&quot;</span><span class="nv">$CLUSTER</span><span class="s2">\&quot;@&quot;</span> <span class="se">\</span>
        -e <span class="s2">&quot;s@^inventory_file =.*@inventory_file = \&quot;../../../inventory/hosts-</span><span class="nv">$CLUSTER</span><span class="s2">\&quot;@&quot;</span> <span class="se">\</span>
        -e <span class="s2">&quot;s@^aws_kube_worker_size =.*@aws_kube_worker_size = \&quot;t3.large\&quot;@&quot;</span> <span class="se">\</span>
    &gt; inventory/terraform-<span class="nv">$CLUSTER</span>.tfvars
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<p>Review and, if needed, adjust the files in <code>kubespray/inventory/</code>.</p>
<h4 id="initialize-and-apply-terraform">Initialize and Apply Terraform</h4>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span> kubespray/contrib/terraform/aws
terraform init
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    terraform apply <span class="se">\</span>
        -var-file<span class="o">=</span>../../../inventory/terraform-<span class="nv">$CLUSTER</span>.tfvars <span class="se">\</span>
        -auto-approve <span class="se">\</span>
        -state<span class="o">=</span>../../../inventory/tfstate-<span class="nv">$CLUSTER</span>.tfstate
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The Terraform state is stored in <code>kubespray/inventory/tfstate-*</code>.
It is precious.
Consider backing it up or using <a href="https://www.terraform.io/docs/cloud/index.html">Terraform Cloud</a>.</p>
</div>
<h4 id="check-that-the-ansible-inventory-was-properly-generated">Check that the Ansible inventory was properly generated</h4>
<div class="highlight"><pre><span></span><code>ls -l kubespray/inventory/hosts-*
</code></pre></div>
<p>You may also want to check the AWS Console if the infrastructure was created correctly:</p>
<p><img alt="Kubespray AWS Console" src="../../img/kubespray-aws-console.png" /></p>
<h3 id="deploying-vanilla-kubernetes-clusters-using-kubespray">Deploying vanilla Kubernetes clusters using Kubespray</h3>
<p>With the infrastructure provisioned, we can now deploy both the sc and wc Kubernetes clusters using kubespray.
Before trying any of the steps, make sure you are in the repo's root folder.</p>
<h4 id="init-the-kubespray-config-in-your-config-path">Init the Kubespray config in your config path</h4>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">CK8S_CONFIG_PATH</span><span class="o">=</span>~/.ck8s/aws
<span class="nb">export</span> <span class="nv">CK8S_PGP_FP</span><span class="o">=</span>&lt;your GPG key fingerprint&gt;  <span class="c1"># retrieve with gpg --list-secret-keys</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    ./bin/ck8s-kubespray init <span class="nv">$CLUSTER</span> aws <span class="nv">$CK8S_PGP_FP</span>
<span class="k">done</span>
</code></pre></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The key in <code>~/.ssh/id_rsa</code> must be the private key of the key referenced in <code>TF_VAR_AWS_SSH_KEY_NAME</code> above.</p>
</div>
<h4 id="copy-the-inventories-generated-by-terraform-above-in-the-right-place">Copy the inventories generated by Terraform above in the right place</h4>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    cp kubespray/inventory/hosts-<span class="nv">$CLUSTER</span> <span class="nv">$CK8S_CONFIG_PATH</span>/<span class="nv">$CLUSTER</span>-config/inventory.ini
<span class="k">done</span>
</code></pre></div>
<h4 id="run-kubespray-to-deploy-the-kubernetes-clusters">Run kubespray to deploy the Kubernetes clusters</h4>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    ./bin/ck8s-kubespray apply <span class="nv">$CLUSTER</span> --flush-cache -e <span class="nv">ansible_user</span><span class="o">=</span>ubuntu
<span class="k">done</span>
</code></pre></div>
<p>This may take up to 20 minutes per cluster.</p>
<h4 id="correct-the-kubernetes-api-ip-addresses">Correct the Kubernetes API IP addresses</h4>
<p>Find the DNS names of the load balancers fronting the API servers:</p>
<div class="highlight"><pre><span></span><code>grep apiserver_loadbalancer <span class="nv">$CK8S_CONFIG_PATH</span>/*-config/inventory.ini
</code></pre></div>
<p>Locate the encrypted kubeconfigs <code>kube_config_*.yaml</code> and edit them using sops.
Copy the URL of the load balancer from inventory files shown above into <code>kube_config_*.yaml</code>.
Do not overwrite the port.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    sops <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml
<span class="k">done</span>
</code></pre></div>
<h4 id="test-access-to-the-clusters-as-follows">Test access to the clusters as follows</h4>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    sops exec-file <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml <span class="se">\</span>
        <span class="s1">&#39;kubectl --kubeconfig {} get nodes&#39;</span>
<span class="k">done</span>
</code></pre></div>
<h2 id="deploying-compliant-kubernetes-apps">Deploying Compliant Kubernetes Apps</h2>
<p>Now that the Kubernetes clusters are up and running, we are ready to install the Compliant Kubernetes apps.</p>
<h3 id="clone-compliantkubernetes-apps-and-install-pre-requisites">Clone <code>compliantkubernetes-apps</code> and Install Pre-requisites</h3>
<p>If you haven't done so already, clone the <code>compliantkubernetes-apps</code> repo and install pre-requisites.</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/elastisys/compliantkubernetes-apps.git
<span class="nb">cd</span> compliantkubernetes-apps
ansible-playbook -e <span class="s1">&#39;ansible_python_interpreter=/usr/bin/python3&#39;</span> --ask-become-pass --connection <span class="nb">local</span> --inventory <span class="m">127</span>.0.0.1, get-requirements.yaml
</code></pre></div>
<h3 id="initialize-the-apps-configuration">Initialize the apps configuration</h3>
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">CK8S_ENVIRONMENT_NAME</span><span class="o">=</span>my-environment-name
<span class="c1">#export CK8S_FLAVOR=[dev|prod] # defaults to dev</span>
<span class="nb">export</span> <span class="nv">CK8S_CONFIG_PATH</span><span class="o">=</span>~/.ck8s/my-cluster-path
<span class="nb">export</span> <span class="nv">CK8S_CLOUD_PROVIDER</span><span class="o">=</span><span class="c1"># [exoscale|safespring|citycloud|aws|baremetal]</span>
<span class="nb">export</span> <span class="nv">CK8S_PGP_FP</span><span class="o">=</span>&lt;your GPG key fingerprint&gt;  <span class="c1"># retrieve with gpg --list-secret-keys</span>
./bin/ck8s init
</code></pre></div>
<p>Three files, <code>sc-config.yaml</code> and <code>wc-config.yaml</code>, and <code>secrets.yaml</code>, were generated in the <code>${CK8S_CONFIG_PATH}</code> directory.</p>
<div class="highlight"><pre><span></span><code>ls -l <span class="nv">$CK8S_CONFIG_PATH</span>
</code></pre></div>
<h3 id="configure-the-apps">Configure the apps</h3>
<p>Edit the configuration files <code>${CK8S_CONFIG_PATH}/sc-config.yaml</code>, <code>${CK8S_CONFIG_PATH}/wc-config.yaml</code> and <code>${CK8S_CONFIG_PATH}/secrets.yaml</code> and set the appropriate values for some of the configuration fields.
Note that, the latter is encrypted.</p>
<div class="highlight"><pre><span></span><code>vim <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/sc-config.yaml
vim <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/wc-config.yaml
sops <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/secrets.yaml
</code></pre></div>
<p>The following are the minimum change you should perform:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># sc-config.yaml and wc-config.yaml</span>
<span class="nt">global</span><span class="p">:</span>
  <span class="nt">baseDomain</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># set to $BASE_DOMAIN</span>
  <span class="nt">opsDomain</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># set to ops.$BASE_DOMAIN</span>
  <span class="nt">issuer</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">letsencrypt-prod</span>

<span class="nt">objectStorage</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="s">&quot;s3&quot;</span>
  <span class="nt">s3</span><span class="p">:</span>
    <span class="nt">region</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># Region for S3 buckets, e.g, eu-central-1</span>
    <span class="nt">regionEndpoint</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># e.g., https://s3.us-west-1.amazonaws.com</span>

<span class="nt">fluentd</span><span class="p">:</span>
  <span class="nt">forwarder</span><span class="p">:</span>
    <span class="nt">useRegionEndpoint</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># set it to either true or false</span>

<span class="nt">issuers</span><span class="p">:</span>
  <span class="nt">letsencrypt</span><span class="p">:</span>
    <span class="nt">email</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span>  <span class="c1"># set this to an email to receive LetsEncrypt notifications</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># secrets.yaml</span>
<span class="nt">objectStorage</span><span class="p">:</span>
  <span class="nt">s3</span><span class="p">:</span>
    <span class="nt">accessKey</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span> <span class="c1">#put your s3 accesskey</span>
    <span class="nt">secretKey</span><span class="p">:</span> <span class="s">&quot;set-me&quot;</span> <span class="c1">#put your s3 secretKey</span>
</code></pre></div>
<h3 id="create-placeholder-dns-entries">Create placeholder DNS entries</h3>
<p>To avoid negative caching and other surprises.
Create two placeholders as follows (feel free to use the "Import zone" feature of AWS Route53):</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">*.</span><span class="nv">$BASE_DOMAIN</span><span class="s2">     60s A 203.0.113.123</span>
<span class="s2">*.ops.</span><span class="nv">$BASE_DOMAIN</span><span class="s2"> 60s A 203.0.113.123</span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>
<p>NOTE: 203.0.113.123 is in <a href="https://en.wikipedia.org/wiki/Reserved_IP_addresses">TEST-NET-3</a> and okey to use as placeholder.</p>
<h3 id="install-compliant-kubernetes-apps">Install Compliant Kubernetes apps</h3>
<p>Start with the service cluster:</p>
<div class="highlight"><pre><span></span><code>ln -sf <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span>.yaml <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_sc.yaml
./bin/ck8s apply sc  <span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
</code></pre></div>
<p>Then the workload clusters:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    ln -sf <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span>.yaml <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_wc.yaml
    ./bin/ck8s apply wc  <span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
<span class="k">done</span>
</code></pre></div>
<h3 id="settling">Settling</h3>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Leave sufficient time for the system to settle, e.g., request TLS certificates from LetsEncrypt, perhaps as much as 20 minutes.</p>
</div>
<p>You can check if the system settled as follows:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    sops exec-file <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml <span class="se">\</span>
        <span class="s1">&#39;kubectl --kubeconfig {} get --all-namespaces pods&#39;</span>
<span class="k">done</span>
</code></pre></div>
<p>Check the output of the command above. All Pods needs to be Running or Completed.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    sops exec-file <span class="si">${</span><span class="nv">CK8S_CONFIG_PATH</span><span class="si">}</span>/.state/kube_config_<span class="nv">$CLUSTER</span>.yaml <span class="se">\</span>
        <span class="s1">&#39;kubectl --kubeconfig {} get --all-namespaces issuers,clusterissuers,certificates&#39;</span>
<span class="k">done</span>
</code></pre></div>
<p>Check the output of the command above.
All resources need to have the Ready column True.</p>
<h3 id="setup-required-dns-entries">Setup required DNS entries</h3>
<p>You will need to set up the following DNS entries.
First, determine the public IP of the load-balancer fronting the Ingress controller of the <em>service cluster</em>:</p>
<div class="highlight"><pre><span></span><code><span class="nv">SC_INGRESS_LB_HOSTNAME</span><span class="o">=</span><span class="k">$(</span>sops exec-file <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_sc.yaml <span class="s1">&#39;kubectl --kubeconfig {} get -n ingress-nginx svc ingress-nginx-controller -o jsonpath={.status.loadBalancer.ingress[0].hostname}&#39;</span><span class="k">)</span>
<span class="nv">SC_INGRESS_LB_IP</span><span class="o">=</span><span class="k">$(</span>dig +short <span class="nv">$SC_INGRESS_LB_HOSTNAME</span> <span class="p">|</span> head -1<span class="k">)</span>
<span class="nb">echo</span> <span class="nv">$SC_INGRESS_LB_IP</span>
</code></pre></div>
<p>Then, import the following zone in AWS Route53:</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">*.ops.</span><span class="nv">$BASE_DOMAIN</span><span class="s2">    60s A </span><span class="nv">$SC_INGRESS_LB_IP</span><span class="s2"></span>
<span class="s2">dex.</span><span class="nv">$BASE_DOMAIN</span><span class="s2">      60s A </span><span class="nv">$SC_INGRESS_LB_IP</span><span class="s2"></span>
<span class="s2">grafana.</span><span class="nv">$BASE_DOMAIN</span><span class="s2">  60s A </span><span class="nv">$SC_INGRESS_LB_IP</span><span class="s2"></span>
<span class="s2">harbor.</span><span class="nv">$BASE_DOMAIN</span><span class="s2">   60s A </span><span class="nv">$SC_INGRESS_LB_IP</span><span class="s2"></span>
<span class="s2">kibana.</span><span class="nv">$BASE_DOMAIN</span><span class="s2">   60s A </span><span class="nv">$SC_INGRESS_LB_IP</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>
<h3 id="testing">Testing</h3>
<p>After completing the installation step you can test if the apps are properly installed and ready using the commands below.</p>
<p>Start with the service cluster:</p>
<div class="highlight"><pre><span></span><code>ln -sf <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span>.yaml <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_sc.yaml
./bin/ck8s <span class="nb">test</span> sc  <span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
</code></pre></div>
<p>Then the workload clusters:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> CLUSTER <span class="k">in</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    ln -sf <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_<span class="si">${</span><span class="nv">CLUSTER</span><span class="si">}</span>.yaml <span class="nv">$CK8S_CONFIG_PATH</span>/.state/kube_config_wc.yaml
    ./bin/ck8s <span class="nb">test</span> wc  <span class="c1"># Respond &quot;n&quot; if you get a WARN</span>
<span class="k">done</span>
</code></pre></div>
<p>Done.
Navigate to the endpoints, for example <code>grafana.$BASE_DOMAIN</code>, <code>kibana.$BASE_DOMAIN</code>, <code>harbor.$BASE_DOMAIN</code>, etc. to discover Compliant Kubernetes's features.</p>
<h2 id="teardown">Teardown</h2>
<h3 id="removing-compliant-kubernetes-apps-from-your-cluster">Removing Compliant Kubernetes Apps from your cluster</h3>
<p>To remove the applications added by compliant kubernetes you can use the two scripts <code>clean-sc.sh</code> and <code>clean-wc.sh</code>, they are located here in the <a href="https://github.com/elastisys/compliantkubernetes-apps/tree/main/scripts">scripts folder</a>.</p>
<p>They perform the following actions:</p>
<ol>
<li>Delete the added helm charts</li>
<li>Delete the added namespaces</li>
<li>Delete any remaining PersistentVolumes</li>
<li>Delete the added CustomResourceDefinitions</li>
</ol>
<p>Note: if user namespaces are managed by Compliant Kubernetes apps then they will also be deleted if you clean up the workload cluster.</p>
<h3 id="remove-infrastructure">Remove infrastructure</h3>
<div class="highlight"><pre><span></span><code><span class="nb">pushd</span> kubespray/contrib/terraform/aws
<span class="k">for</span> CLUSTER <span class="k">in</span> <span class="si">${</span><span class="nv">SERVICE_CLUSTER</span><span class="si">}</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">WORKLOAD_CLUSTERS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
    terraform destroy <span class="se">\</span>
        -auto-approve <span class="se">\</span>
        -state<span class="o">=</span>../../../inventory/tfstate-<span class="nv">$CLUSTER</span>.tfstate
<span class="k">done</span>
<span class="nb">popd</span>
</code></pre></div>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://github.com/elastisys/compliantkubernetes-apps">Compliant Kubernetes apps repo</a></li>
<li><a href="https://github.com/elastisys/compliantkubernetes-apps#elastisys-compliant-kubernetes-apps">Configurations option</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../getting-started/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Getting Started
            </div>
          </div>
        </a>
      
      
        <a href="../azure/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              On Azure
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright © 2020 Elastisys AB
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.d892486b.min.js"></script>
      
    
  </body>
</html>